-- =============================================
-- SISTEMA COMPLETO DE CONTROLE DE ESTOQUE TI
-- COM PERMISS√ïES CORRETAS: ADMIN GERENCIA ESTOQUE E APROVA
-- T√âCNICO DE MANUTEN√á√ÉO TEM ACESSO COMPLETO
-- =============================================

-- üóÉÔ∏è CRIA√á√ÉO DO BANCO DE DADOS
DROP DATABASE IF EXISTS controle_estoque_ti;
CREATE DATABASE controle_estoque_ti;
USE controle_estoque_ti;

-- üë• TABELA DE USU√ÅRIOS COM PERMISS√ïES CORRETAS
CREATE TABLE usuarios (
    id INT PRIMARY KEY AUTO_INCREMENT,
    nome VARCHAR(100) NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    senha VARCHAR(255) NOT NULL,
    
    -- PERFIS REAIS DA EMPRESA
    perfil ENUM('admin', 'tecnico_manutencao', 'coordenador', 'gerente', 'tecnico', 'analista', 'estagiario', 'aprendiz') DEFAULT 'tecnico',
    departamento VARCHAR(50),
    usuario_superior_id INT NULL,
    
    -- PERMISS√ïES PRINCIPAIS
    pode_consultar BOOLEAN DEFAULT TRUE,
    pode_solicitar BOOLEAN DEFAULT FALSE,
    pode_cadastrar BOOLEAN DEFAULT FALSE,
    pode_editar BOOLEAN DEFAULT FALSE,
    
    -- PERMISS√ïES ESPEC√çFICAS
    permissao_criar_solicitacao BOOLEAN DEFAULT FALSE,
    permissao_editar_propria BOOLEAN DEFAULT TRUE,
    permissao_aprovar_solicitacoes BOOLEAN DEFAULT FALSE,
    permissao_gerenciar_usuarios BOOLEAN DEFAULT FALSE,
    permissao_acesso_dashboard BOOLEAN DEFAULT FALSE,
    permissao_relatorios_completos BOOLEAN DEFAULT FALSE,
    permissao_liberar_equipe BOOLEAN DEFAULT FALSE,
    
    -- CONTROLES DE ESTOQUE
    responsavel_estoque BOOLEAN DEFAULT FALSE,
    acesso_historico_completo BOOLEAN DEFAULT FALSE,
    receber_alertas_estoque BOOLEAN DEFAULT FALSE,
    
    -- LIMITES OPERACIONAIS
    max_itens_solicitacao INT DEFAULT 5,
    valor_max_solicitacao DECIMAL(10,2) DEFAULT 1000.00,
    prazo_max_devolucao INT DEFAULT 30,
    
    ativo BOOLEAN DEFAULT TRUE,
    criado_em TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    atualizado_em TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (usuario_superior_id) REFERENCES usuarios(id)
);

-- üì¶ CATEGORIAS DE EQUIPAMENTOS
CREATE TABLE categorias (
    id INT PRIMARY KEY AUTO_INCREMENT,
    nome VARCHAR(50) NOT NULL UNIQUE,
    descricao TEXT,
    criado_em TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- üîß MODELOS DE EQUIPAMENTOS
CREATE TABLE modelos_equipamentos (
    id INT PRIMARY KEY AUTO_INCREMENT,
    nome_modelo VARCHAR(100) NOT NULL,
    fabricante VARCHAR(100),
    categoria_id INT,
    especificacoes_padrao JSON,
    codigos_conhecidos JSON,
    criado_em TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (categoria_id) REFERENCES categorias(id)
);

-- üîß TABELA PRINCIPAL DE ITENS/EQUIPAMENTOS
CREATE TABLE itens (
    id INT PRIMARY KEY AUTO_INCREMENT,
    nome VARCHAR(100) NOT NULL,
    descricao TEXT,
    numero_serie VARCHAR(100) UNIQUE,
    patrimonio VARCHAR(50) UNIQUE,
    codigo_barras VARCHAR(100) UNIQUE,
    
    categoria_id INT NOT NULL,
    localizacao VARCHAR(100),
    
    -- Status do item
    status ENUM('disponivel', 'em_uso', 'manutencao', 'descarte', 'reservado') DEFAULT 'disponivel',
    estado ENUM('novo', 'usado', 'danificado', 'irrecuperavel') DEFAULT 'novo',
    
    -- Informa√ß√µes de aquisi√ß√£o
    data_aquisicao DATE,
    valor_compra DECIMAL(10,2),
    fornecedor VARCHAR(100),
    nota_fiscal VARCHAR(100),
    
    -- Campos t√©cnicos
    especificacoes JSON,
    qr_code VARCHAR(255),
    foto VARCHAR(255),
    
    -- Controles
    quantidade INT DEFAULT 1,
    estoque_minimo INT DEFAULT 0,
    
    criado_por INT,
    criado_em TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    atualizado_em TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (categoria_id) REFERENCES categorias(id),
    FOREIGN KEY (criado_por) REFERENCES usuarios(id)
);

-- üìã HIST√ìRICO DE MOVIMENTA√á√ïES
CREATE TABLE movimentacoes (
    id INT PRIMARY KEY AUTO_INCREMENT,
    item_id INT NOT NULL,
    usuario_id INT NOT NULL,
    
    tipo ENUM('entrada', 'saida', 'devolucao', 'ajuste', 'transferencia') NOT NULL,
    quantidade INT NOT NULL,
    
    -- Para sa√≠das: quem recebeu o item
    destinatario VARCHAR(100),
    departamento_destino VARCHAR(50),
    data_devolucao_prevista DATE,
    
    -- Controles
    data_movimentacao TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    observacao TEXT,
    
    FOREIGN KEY (item_id) REFERENCES itens(id),
    FOREIGN KEY (usuario_id) REFERENCES usuarios(id)
);

-- üîß REGISTRO DE MANUTEN√á√ïES
CREATE TABLE manutencoes (
    id INT PRIMARY KEY AUTO_INCREMENT,
    item_id INT NOT NULL,
    usuario_id INT NOT NULL,
    
    tipo_manutencao ENUM('preventiva', 'corretiva', 'instalacao') NOT NULL,
    descricao_problema TEXT,
    descricao_solucao TEXT,
    
    -- Datas importantes
    data_abertura TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    data_conclusao TIMESTAMP NULL,
    
    -- Custos
    custo_manutencao DECIMAL(10,2),
    fornecedor_manutencao VARCHAR(100),
    
    status ENUM('aberta', 'em_andamento', 'concluida', 'cancelada') DEFAULT 'aberta',
    
    FOREIGN KEY (item_id) REFERENCES itens(id),
    FOREIGN KEY (usuario_id) REFERENCES usuarios(id)
);

-- üìù TABELA DE SOLICITA√á√ïES COM FLUXOS AVAN√áADOS
CREATE TABLE solicitacoes (
    id INT PRIMARY KEY AUTO_INCREMENT,
    codigo_solicitacao VARCHAR(20) UNIQUE NOT NULL,
    usuario_solicitante_id INT NOT NULL,
    usuario_aprovador_id INT NULL,
    
    -- Dados da Solicita√ß√£o
    titulo VARCHAR(255) NOT NULL,
    descricao TEXT,
    prioridade ENUM('baixa', 'media', 'alta', 'urgente') DEFAULT 'media',
    tipo ENUM('equipamento', 'material', 'software', 'manutencao') DEFAULT 'equipamento',
    
    -- Tipo de solicita√ß√£o e or√ßamento
    tipo_solicitacao ENUM('retirada_estoque', 'compra_novo') DEFAULT 'retirada_estoque',
    orcamento_estimado DECIMAL(10,2) DEFAULT NULL,
    fornecedor_sugerido VARCHAR(100) DEFAULT NULL,
    link_referencia VARCHAR(255) DEFAULT NULL,
    urgencia_compra ENUM('baixa', 'media', 'alta', 'imediata') DEFAULT 'media',
    
    -- Fluxo de Aprova√ß√£o
    status ENUM(
        'rascunho', 
        'pendente', 
        'em_analise', 
        'aprovada', 
        'rejeitada', 
        'entregue', 
        'devolvida', 
        'cancelada'
    ) DEFAULT 'rascunho',
    
    -- Controle de fluxo hier√°rquico
    nivel_aprovacao_atual INT DEFAULT 1,
    fluxo_aprovacao JSON,
    
    -- Datas do Fluxo
    data_solicitacao TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    data_aprovacao TIMESTAMP NULL,
    data_entrega TIMESTAMP NULL,
    data_devolucao_prevista DATE NULL,
    data_devolucao_efetiva TIMESTAMP NULL,
    
    -- Controles
    motivo_rejeicao TEXT,
    observacoes_entrega TEXT,
    
    FOREIGN KEY (usuario_solicitante_id) REFERENCES usuarios(id),
    FOREIGN KEY (usuario_aprovador_id) REFERENCES usuarios(id)
);

-- üì¶ TABELA DE ITENS SOLICITADOS COM CONTROLE AVAN√áADO
CREATE TABLE solicitacao_itens (
    id INT PRIMARY KEY AUTO_INCREMENT,
    solicitacao_id INT NOT NULL,
    item_id INT NULL,
    modelo_equipamento_id INT NULL,
    
    -- Dados do Item Solicitado
    nome_item VARCHAR(255) NOT NULL,
    quantidade_solicitada INT NOT NULL,
    quantidade_aprovada INT DEFAULT 0,
    quantidade_entregue INT DEFAULT 0,
    
    -- Controle para compras
    tipo_item ENUM('estoque', 'novo') DEFAULT 'estoque',
    valor_unitario_estimado DECIMAL(10,2) DEFAULT NULL,
    fornecedor VARCHAR(100) DEFAULT NULL,
    link_produto VARCHAR(255) DEFAULT NULL,
    especificacoes_tecnicas JSON,
    
    -- Especifica√ß√µes
    especificacoes JSON,
    motivo_uso TEXT,
    urgencia ENUM('normal', 'urgente', 'critico') DEFAULT 'normal',
    
    -- Controles de Aprova√ß√£o
    status_item ENUM('pendente', 'aprovado', 'rejeitado', 'entregue', 'devolvido') DEFAULT 'pendente',
    observacao_aprovador TEXT,
    
    FOREIGN KEY (solicitacao_id) REFERENCES solicitacoes(id) ON DELETE CASCADE,
    FOREIGN KEY (item_id) REFERENCES itens(id),
    FOREIGN KEY (modelo_equipamento_id) REFERENCES modelos_equipamentos(id)
);

-- üîÑ HIST√ìRICO DE SOLICITA√á√ïES
CREATE TABLE historico_solicitacoes (
    id INT PRIMARY KEY AUTO_INCREMENT,
    solicitacao_id INT NOT NULL,
    usuario_id INT NOT NULL,
    acao ENUM(
        'criacao', 
        'edicao', 
        'envio_aprovacao', 
        'aprovacao', 
        'rejeicao', 
        'entrega', 
        'devolucao',
        'cancelamento'
    ) NOT NULL,
    descricao TEXT NOT NULL,
    dados_alterados JSON,
    data_acao TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (solicitacao_id) REFERENCES solicitacoes(id),
    FOREIGN KEY (usuario_id) REFERENCES usuarios(id)
);

-- üìù TABELA DE HIST√ìRICO (AUDITORIA)
CREATE TABLE historico_alteracoes (
    id INT PRIMARY KEY AUTO_INCREMENT,
    tabela_afetada VARCHAR(50) NOT NULL,
    registro_id INT NOT NULL,
    acao ENUM('INSERT', 'UPDATE', 'DELETE') NOT NULL,
    valores_antigos JSON,
    valores_novos JSON,
    usuario_id INT,
    data_alteracao TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (usuario_id) REFERENCES usuarios(id)
);

-- üîî TABELA DE CONFIGURA√á√ïES E ALERTAS
CREATE TABLE configuracoes (
    id INT PRIMARY KEY AUTO_INCREMENT,
    chave VARCHAR(50) UNIQUE NOT NULL,
    valor TEXT,
    descricao TEXT,
    atualizado_em TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- üî¥ TABELA DE ALERTAS DE ESTOQUE BAIXO
CREATE TABLE alertas_estoque (
    id INT PRIMARY KEY AUTO_INCREMENT,
    item_id INT NOT NULL,
    nivel_alerta ENUM('baixo', 'critico', 'zero') NOT NULL,
    quantidade_atual INT NOT NULL,
    estoque_minimo INT NOT NULL,
    mensagem TEXT NOT NULL,
    lido BOOLEAN DEFAULT FALSE,
    data_alerta TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    data_leitura TIMESTAMP NULL,
    
    FOREIGN KEY (item_id) REFERENCES itens(id) ON DELETE CASCADE
);

-- üéØ TABELA DE FLUXOS DE APROVA√á√ÉO
CREATE TABLE fluxos_aprovacao (
    id INT PRIMARY KEY AUTO_INCREMENT,
    nome VARCHAR(100) NOT NULL,
    descricao TEXT,
    condicoes JSON,
    niveis JSON NOT NULL,
    ativo BOOLEAN DEFAULT TRUE,
    criado_em TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- =============================================
-- √çNDICES PARA OTIMIZA√á√ÉO
-- =============================================

-- √çndices para ITENS
CREATE INDEX idx_itens_categoria ON itens(categoria_id);
CREATE INDEX idx_itens_status ON itens(status);
CREATE INDEX idx_itens_estado ON itens(estado);
CREATE INDEX idx_itens_patrimonio ON itens(patrimonio);
CREATE INDEX idx_itens_numero_serie ON itens(numero_serie);
CREATE INDEX idx_itens_localizacao ON itens(localizacao);
CREATE INDEX idx_itens_quantidade ON itens(quantidade);
CREATE INDEX idx_itens_codigo_barras ON itens(codigo_barras);

-- √çndices para MOVIMENTACOES
CREATE INDEX idx_movimentacoes_item ON movimentacoes(item_id);
CREATE INDEX idx_movimentacoes_usuario ON movimentacoes(usuario_id);
CREATE INDEX idx_movimentacoes_data ON movimentacoes(data_movimentacao);
CREATE INDEX idx_movimentacoes_tipo ON movimentacoes(tipo);

-- √çndices para MANUTENCOES
CREATE INDEX idx_manutencoes_item ON manutencoes(item_id);
CREATE INDEX idx_manutencoes_status ON manutencoes(status);
CREATE INDEX idx_manutencoes_data_abertura ON manutencoes(data_abertura);

-- √çndices para USUARIOS
CREATE INDEX idx_usuarios_email ON usuarios(email);
CREATE INDEX idx_usuarios_perfil ON usuarios(perfil);
CREATE INDEX idx_usuarios_departamento ON usuarios(departamento);
CREATE INDEX idx_usuarios_superior ON usuarios(usuario_superior_id);

-- √çndices para SOLICITA√á√ïES
CREATE INDEX idx_solicitacao_status ON solicitacoes(status);
CREATE INDEX idx_solicitacao_data ON solicitacoes(data_solicitacao);
CREATE INDEX idx_solicitacao_usuario ON solicitacoes(usuario_solicitante_id);
CREATE INDEX idx_solicitacao_codigo ON solicitacoes(codigo_solicitacao);
CREATE INDEX idx_solicitacao_tipo ON solicitacoes(tipo_solicitacao);

-- √çndices para SOLICITACAO_ITENS
CREATE INDEX idx_solicitacao_item ON solicitacao_itens(solicitacao_id);
CREATE INDEX idx_item_status ON solicitacao_itens(status_item);
CREATE INDEX idx_tipo_item ON solicitacao_itens(tipo_item);

-- √çndices para ALERTAS
CREATE INDEX idx_alertas_item ON alertas_estoque(item_id);
CREATE INDEX idx_alertas_lido ON alertas_estoque(lido);
CREATE INDEX idx_alertas_data ON alertas_estoque(data_alerta);
CREATE INDEX idx_alertas_nivel ON alertas_estoque(nivel_alerta);

-- =============================================
-- DADOS INICIAIS CORRETOS COM PERMISS√ïES REAIS
-- =============================================

-- üë• USU√ÅRIOS PADR√ÉO CORRETOS (senha: 123456)
INSERT INTO usuarios (nome, email, senha, perfil, departamento, usuario_superior_id, 
    pode_consultar, pode_solicitar, pode_cadastrar, pode_editar,
    permissao_criar_solicitacao, permissao_editar_propria, permissao_aprovar_solicitacoes,
    permissao_gerenciar_usuarios, permissao_acesso_dashboard, permissao_relatorios_completos,
    permissao_liberar_equipe, responsavel_estoque, acesso_historico_completo, receber_alertas_estoque,
    max_itens_solicitacao, valor_max_solicitacao, prazo_max_devolucao) VALUES
    
-- 1. ADMIN GERAL - RESPONS√ÅVEL PELO ESTOQUE E APROVA√á√ïES
('Administrador Sistema', 'admin@empresa.com', '$2b$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', 
 'admin', 'TI', NULL, 
 TRUE, TRUE, TRUE, TRUE,  -- Todas as permiss√µes b√°sicas
 TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, 50, 10000.00, 90),
 
-- 2. T√âCNICO DE MANUTEN√á√ÉO - ACESSO COMPLETO OPERACIONAL
('T√©cnico Manuten√ß√£o Jo√£o', 'joao.manutencao@empresa.com', '$2b$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', 
 'tecnico_manutencao', 'MANUTEN√á√ÉO', 1, 
 TRUE, TRUE, TRUE, TRUE,  -- Acesso completo para operar
 TRUE, TRUE, FALSE, FALSE, TRUE, TRUE, FALSE, FALSE, TRUE, TRUE, 20, 3000.00, 60),
 
-- 3. COORDENADOR TI - PODE APROVAR SOLICITA√á√ïES
('Coordenador TI', 'coordenador.ti@empresa.com', '$2b$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', 
 'coordenador', 'TI', 1,
 TRUE, TRUE, TRUE, TRUE,  -- Pode cadastrar e editar, aprovar solicita√ß√µes
 TRUE, TRUE, TRUE, FALSE, TRUE, FALSE, TRUE, FALSE, TRUE, TRUE, 20, 2000.00, 60),
 
-- 4. GERENTE TI - PODE APROVAR SOLICITA√á√ïES
('Gerente TI', 'gerente.ti@empresa.com', '$2b$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', 
 'gerente', 'TI', 1,
 TRUE, TRUE, FALSE, FALSE,  -- Pode consultar e solicitar, aprovar
 TRUE, TRUE, TRUE, FALSE, TRUE, FALSE, TRUE, FALSE, TRUE, TRUE, 20, 2000.00, 60),
 
-- 5. T√âCNICOS - ACESSO OPERACIONAL B√ÅSICO
('T√©cnico Pedro Silva', 'pedro.ti@empresa.com', '$2b$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', 
 'tecnico', 'TI', 3,
 TRUE, TRUE, TRUE, TRUE,  -- T√©cnico tem acesso para operar
 TRUE, TRUE, FALSE, FALSE, TRUE, FALSE, FALSE, FALSE, TRUE, TRUE, 15, 1500.00, 45),
 
('T√©cnica Maria Santos', 'maria.ti@empresa.com', '$2b$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', 
 'tecnico', 'TI', 4,
 TRUE, TRUE, TRUE, TRUE,  -- T√©cnico tem acesso para operar
 TRUE, TRUE, FALSE, FALSE, TRUE, FALSE, FALSE, FALSE, TRUE, TRUE, 15, 1500.00, 45),
 
-- 6. ANALISTA - PODE SOLICITAR E CONSULTAR
('Analista Carlos Costa', 'carlos.ti@empresa.com', '$2b$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', 
 'analista', 'TI', 3,
 TRUE, TRUE, FALSE, FALSE,  -- Pode consultar e solicitar
 TRUE, TRUE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, 8, 800.00, 30),
 
-- 7. ESTAGI√ÅRIO - S√ì CONSULTA
('Estagi√°rio Ana Oliveira', 'ana.estag@empresa.com', '$2b$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', 
 'estagiario', 'TI', 3,
 TRUE, FALSE, FALSE, FALSE,  -- S√≥ pode consultar
 TRUE, TRUE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, 3, 300.00, 15),
 
-- 8. APRENDIZ - S√ì CONSULTA
('Aprendiz Lucas Rodrigues', 'lucas.aprendiz@empresa.com', '$2b$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', 
 'aprendiz', 'TI', 4,
 TRUE, FALSE, FALSE, FALSE,  -- S√≥ pode consultar
 TRUE, TRUE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, 3, 200.00, 15);

-- üì¶ CATEGORIAS
INSERT INTO categorias (nome, descricao) VALUES
('Notebooks', 'Laptops e notebooks corporativos'),
('Perif√©ricos', 'Teclados, mouses, monitores, impressoras'),
('Rede e Conectividade', 'Roteadores, switches, cabos de rede, access points'),
('Hardware', 'Mem√≥rias, HDs, SSDs, processadores, fontes'),
('Software', 'Licen√ßas e aplicativos'),
('Cabos e Adaptadores', 'Cabos diversos e adaptadores'),
('Telefonia', 'Telefones IP e headsets'),
('Seguran√ßa', 'NO-breaks, estabilizadores, racks'),
('Componentes', 'Pe√ßas e componentes avulsos');

-- üîß MODELOS DE EQUIPAMENTOS
INSERT INTO modelos_equipamentos (nome_modelo, fabricante, categoria_id, codigos_conhecidos) VALUES
('MikroTik Router hAP ac3', 'MikroTik', 3, '["3b0602749372", "3b060232a806", "3b0602"]'),
('MikroTik Router RB4011', 'MikroTik', 3, '["3b0603", "3b0604"]'),
('MikroTik Switch CRS326', 'MikroTik', 3, '["3b0605", "3b0606"]'),
('Dell Latitude 5420', 'Dell', 1, '["DL5420", "LAT5420"]'),
('Lenovo ThinkPad T14', 'Lenovo', 1, '["T14", "THINKPADT14"]');

-- üîß ITENS DE EXEMPLO
INSERT INTO itens (nome, descricao, categoria_id, numero_serie, patrimonio, codigo_barras, status, estado, quantidade, estoque_minimo, valor_compra, data_aquisicao, fornecedor) VALUES
('Notebook Dell Latitude 5420', 'Intel i5 10¬™ gera√ß√£o, 8GB RAM, 256GB SSD, Tela 14"', 1, 'DL5420XYZ123', 'PAT-IT-001', '7891234567890', 'disponivel', 'novo', 3, 1, 4200.00, '2024-01-15', 'Dell Brasil'),
('Mouse Logitech M170 Wireless', 'Mouse wireless preto, 1000DPI, bateria inclu√≠da', 2, 'ML170ABC456', 'PAT-IT-002', '7891234567891', 'disponivel', 'novo', 25, 10, 45.90, '2024-02-10', 'Logitech'),
('Cabo de Rede CAT6 2m Azul', 'Cabo de rede CAT6 azul 2 metros, blindado', 3, NULL, NULL, '7891234567892', 'disponivel', 'novo', 50, 15, 12.50, '2024-01-20', 'Fornecedor Cabos'),
('Licen√ßa Windows 10 Pro', 'Licen√ßa volume license para 1 m√°quina', 5, 'WIN10-VL-789', NULL, '7891234567893', 'disponivel', 'novo', 12, 5, 299.00, '2024-01-05', 'Microsoft'),
('Monitor Samsung 24" FHD', 'Monitor LED 24 polegadas, Full HD, HDMI/VGA', 2, 'SM24FHD555', 'PAT-IT-005', '7891234567894', 'em_uso', 'usado', 1, 0, 899.00, '2023-11-20', 'Samsung'),
('Switch TP-Link 8 Portas', 'Switch Gigabit 8 portas, desktop', 3, 'TPLINK888', 'PAT-IT-006', '7891234567895', 'disponivel', 'novo', 2, 1, 150.00, '2024-02-01', 'TP-Link'),
('Notebook Lenovo ThinkPad', 'Intel i7, 16GB RAM, 512GB SSD, em manuten√ß√£o', 1, 'LEN789THINK', 'PAT-IT-007', '7891234567896', 'manutencao', 'usado', 1, 0, 5800.00, '2023-09-10', 'Lenovo'),
('Teclado Microsoft sem fio', 'Teclado wireless, layout ABNT2, bateria inclu√≠da', 2, 'MSWIRELESS222', NULL, '7891234567897', 'disponivel', 'novo', 8, 3, 129.90, '2024-02-15', 'Microsoft'),
('SSD Kingston 480GB', 'SSD SATA 480GB, 2.5", para upgrades', 4, 'KSSD480333', NULL, '7891234567898', 'disponivel', 'novo', 6, 2, 199.00, '2024-01-25', 'Kingston'),
('NO-break SMS 600VA', 'Estabilizador 600VA, 4 tomadas, prote√ß√£o', 8, 'SMS600VA444', 'PAT-IT-010', '7891234567899', 'disponivel', 'novo', 4, 1, 280.00, '2024-02-05', 'SMS'),
('Cabo HDMI 1.8m', 'Cabo HDMI high speed 1.8 metros, dourado', 6, NULL, NULL, '7891234567900', 'disponivel', 'novo', 2, 5, 25.00, '2024-02-10', 'Fornecedor Cabos'),
('Adaptador USB-C para HDMI', 'Adaptador USB-C para HDMI 4K', 6, 'USBCHDMI777', NULL, '7891234567901', 'disponivel', 'novo', 1, 3, 89.90, '2024-02-12', 'Fornecedor Acess√≥rios'),
('Mem√≥ria RAM 8GB DDR4', 'Mem√≥ria RAM 8GB DDR4 2666MHz', 4, 'RAM8GBDDR4888', NULL, '7891234567902', 'disponivel', 'novo', 0, 2, 189.00, '2024-01-30', 'Kingston');

-- üìã MOVIMENTA√á√ïES
INSERT INTO movimentacoes (item_id, usuario_id, tipo, quantidade, destinatario, departamento_destino, observacao) VALUES
(5, 3, 'saida', 1, 'Carlos Silva', 'Financeiro', 'Entrega para novo colaborador'),
(1, 4, 'saida', 1, 'Ana Oliveira', 'Marketing', 'Equipamento para home office'),
(8, 3, 'saida', 2, 'Setor Atendimento', 'Atendimento', 'Reposi√ß√£o de teclados danificados'),
(6, 5, 'saida', 1, 'Roberto Santos', 'TI', 'Instala√ß√£o na sala de servidores'),
(11, 3, 'saida', 3, 'Departamento Vendas', 'Vendas', 'Cabos para novas esta√ß√µes');

-- üîß MANUTEN√á√ïES
INSERT INTO manutencoes (item_id, usuario_id, tipo_manutencao, descricao_problema, descricao_solucao, status, data_abertura) VALUES
(7, 2, 'corretiva', 'N√£o liga - poss√≠vel problema na fonte', 'Troca da fonte de alimenta√ß√£o realizada', 'concluida', '2024-02-18 09:30:00'),
(5, 2, 'preventiva', 'Limpeza interna e atualiza√ß√£o de drivers', 'Limpeza completa e drivers atualizados', 'concluida', '2024-02-20 14:15:00'),
(1, 2, 'corretiva', 'Tecla espa√ßo n√£o funciona', 'Aguardando pe√ßa para troca do teclado', 'em_andamento', '2024-02-22 10:00:00');

-- üìù SOLICITA√á√ïES COM NOVOS CAMPOS
INSERT INTO solicitacoes (codigo_solicitacao, usuario_solicitante_id, titulo, descricao, prioridade, tipo, tipo_solicitacao, orcamento_estimado, status, data_solicitacao) VALUES
('SOL-2024-001', 5, 'Equipamento para novo colaborador', 'Solicito equipamento para novo analista do departamento comercial', 'alta', 'equipamento', 'retirada_estoque', NULL, 'pendente', '2024-02-25 09:00:00'),
('SOL-2024-002', 6, 'Reposi√ß√£o de cabos HDMI', 'Necess√°rio cabos HDMI para as novas telas de apresenta√ß√£o', 'media', 'material', 'compra_novo', 125.00, 'pendente', '2024-02-25 10:30:00'),
('SOL-2024-003', 7, 'Notebook para visita t√©cnica', 'Equipamento para apresenta√ß√µes em visitas a clientes', 'alta', 'equipamento', 'compra_novo', 3500.00, 'rascunho', '2024-02-25 11:15:00');

-- üì¶ ITENS DAS SOLICITA√á√ïES COM NOVOS CAMPOS - CORRIGIDO
INSERT INTO solicitacao_itens (solicitacao_id, item_id, nome_item, quantidade_solicitada, tipo_item, valor_unitario_estimado, motivo_uso, urgencia) VALUES
(1, 1, 'Notebook Dell Latitude 5420', 1, 'estoque', NULL, 'Para novo colaborador do comercial', 'urgente'),
(1, 8, 'Teclado Microsoft sem fio', 1, 'estoque', NULL, 'Kit teclado/mouse para nova esta√ß√£o', 'normal'),
(2, NULL, 'Cabo HDMI 2m', 5, 'novo', 25.00, 'Para salas de reuni√£o e telas de apresenta√ß√£o', 'normal'),
(3, NULL, 'Notebook para apresenta√ß√µes', 1, 'novo', 3500.00, 'Visitas t√©cnicas e demonstra√ß√µes', 'urgente');

-- üéØ FLUXOS DE APROVA√á√ÉO
INSERT INTO fluxos_aprovacao (nome, descricao, condicoes, niveis, ativo) VALUES
('Fluxo Simples', 'Para solicita√ß√µes at√© R$ 1.000', '{"valor_maximo": 1000}', 
 '[{"nivel": 1, "perfil": "coordenador", "descricao": "Aprova√ß√£o do Coordenador"}]', TRUE),
 
('Fluxo Completo', 'Para solicita√ß√µes acima de R$ 1.000', '{"valor_minimo": 1000.01, "valor_maximo": 5000}',
 '[{"nivel": 1, "perfil": "coordenador", "descricao": "Aprova√ß√£o do Coordenador"},
   {"nivel": 2, "perfil": "admin", "descricao": "Aprova√ß√£o do Administrador"}]', TRUE),
 
('Fluxo Cr√≠tico', 'Para solicita√ß√µes acima de R$ 5.000', '{"valor_minimo": 5000.01}',
 '[{"nivel": 1, "perfil": "coordenador", "descricao": "Aprova√ß√£o do Coordenador"},
   {"nivel": 2, "perfil": "gerente", "descricao": "Aprova√ß√£o do Gerente"},
   {"nivel": 3, "perfil": "admin", "descricao": "Aprova√ß√£o do Administrador"}]', TRUE);

-- üîî CONFIGURA√á√ïES
INSERT INTO configuracoes (chave, valor, descricao) VALUES
('EMAIL_NOTIFICACOES', 'true', 'Habilitar notifica√ß√µes por email'),
('ESTOQUE_MINIMO_ALERTA', 'true', 'Alertar quando item atingir estoque m√≠nimo'),
('DIAS_DEVOLUCAO', '15', 'Prazo padr√£o para devolu√ß√£o de equipamentos'),
('EMPRESA_NOME', 'Sua Empresa LTDA', 'Nome da empresa para relat√≥rios'),
('ALERTA_ESTOQUE_BAIXO', 'true', 'Habilitar alertas quando estoque estiver baixo'),
('NIVEL_ALERTA_BAIXO', '5', 'Quantidade para alerta de estoque baixo'),
('NIVEL_ALERTA_CRITICO', '2', 'Quantidade para alerta de estoque cr√≠tico'),
('EMAIL_ALERTAS_ESTOQUE', 'admin@empresa.com', 'Emails para receber alertas de estoque'),
('SOLICITACOES_ATIVAS', 'true', 'Habilitar sistema de solicita√ß√µes'),
('APROVACAO_OBRIGATORIA', 'true', 'Solicita√ß√µes exigem aprova√ß√£o do gestor'),
('PRAZO_APROVACAO', '48', 'Prazo em horas para aprova√ß√£o de solicita√ß√µes'),
('EMAIL_SOLICITACOES', 'true', 'Enviar emails para novas solicita√ß√µes'),
('LIMITE_ITENS_POR_SOLICITACAO', '10', 'N√∫mero m√°ximo de itens por solicita√ß√£o'),
('FLUXO_APROVACAO_ATIVO', 'true', 'Habilitar fluxos de aprova√ß√£o hier√°rquicos'),
('VALOR_FLUXO_SIMPLES', '1000', 'Valor m√°ximo para fluxo simples'),
('VALOR_FLUXO_COMPLETO', '5000', 'Valor m√°ximo para fluxo completo');

-- üî¥ ALERTAS
INSERT INTO alertas_estoque (item_id, nivel_alerta, quantidade_atual, estoque_minimo, mensagem) VALUES
(11, 'baixo', 2, 5, 'Cabo HDMI 1.8m est√° com estoque baixo. Quantidade atual: 2, M√≠nimo: 5'),
(12, 'critico', 1, 3, 'Adaptador USB-C para HDMI est√° com estoque cr√≠tico. Quantidade atual: 1, M√≠nimo: 3'),
(13, 'zero', 0, 2, 'Mem√≥ria RAM 8GB DDR4 est√° com estoque ZERO. Quantidade atual: 0, M√≠nimo: 2');

-- =============================================
-- STORED PROCEDURES
-- =============================================

DELIMITER //

-- PROCEDURE PARA GERAR C√ìDIGO DE SOLICITA√á√ÉO
CREATE PROCEDURE GerarCodigoSolicitacao(OUT codigo VARCHAR(20))
BEGIN
    DECLARE ano VARCHAR(4);
    DECLARE sequencia INT;
    
    SET ano = YEAR(CURDATE());
    
    SELECT COALESCE(MAX(CAST(SUBSTRING(codigo_solicitacao, 9) AS UNSIGNED)), 0) + 1 
    INTO sequencia
    FROM solicitacoes 
    WHERE codigo_solicitacao LIKE CONCAT('SOL-', ano, '-%');
    
    SET codigo = CONCAT('SOL-', ano, '-', LPAD(sequencia, 3, '0'));
END//

-- PROCEDURE PARA VERIFICAR ALERTAS DE ESTOQUE
CREATE PROCEDURE VerificarAlertasEstoque()
BEGIN
    DECLARE done INT DEFAULT FALSE;
    DECLARE item_id INT;
    DECLARE item_nome VARCHAR(100);
    DECLARE item_quantidade INT;
    DECLARE item_estoque_minimo INT;
    DECLARE alerta_existente INT;
    
    DECLARE cur_itens CURSOR FOR 
    SELECT i.id, i.nome, i.quantidade, i.estoque_minimo
    FROM itens i
    WHERE i.quantidade <= i.estoque_minimo 
    AND i.quantidade >= 0;
    
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
    
    OPEN cur_itens;
    
    read_loop: LOOP
        FETCH cur_itens INTO item_id, item_nome, item_quantidade, item_estoque_minimo;
        IF done THEN
            LEAVE read_loop;
        END IF;
        
        SET @nivel_alerta = CASE
            WHEN item_quantidade = 0 THEN 'zero'
            WHEN item_quantidade <= 2 THEN 'critico'
            ELSE 'baixo'
        END;
        
        SELECT COUNT(*) INTO alerta_existente 
        FROM alertas_estoque 
        WHERE item_id = item_id 
        AND lido = FALSE 
        AND nivel_alerta = @nivel_alerta;
        
        IF alerta_existente = 0 THEN
            INSERT INTO alertas_estoque (item_id, nivel_alerta, quantidade_atual, estoque_minimo, mensagem)
            VALUES (
                item_id, 
                @nivel_alerta, 
                item_quantidade, 
                item_estoque_minimo,
                CONCAT(
                    item_nome, 
                    ' est√° com estoque ', 
                    CASE @nivel_alerta 
                        WHEN 'zero' THEN 'ZERO' 
                        WHEN 'critico' THEN 'cr√≠tico' 
                        ELSE 'baixo' 
                    END,
                    '. Quantidade atual: ', 
                    item_quantidade, 
                    ', M√≠nimo: ', 
                    item_estoque_minimo
                )
            );
        END IF;
    END LOOP;
    
    CLOSE cur_itens;
END//

-- PROCEDURE PARA DETERMINAR FLUXO DE APROVA√á√ÉO
CREATE PROCEDURE DeterminarFluxoAprovacao(IN valor_total DECIMAL(10,2), OUT fluxo_id INT)
BEGIN
    IF valor_total <= 1000 THEN
        SELECT id INTO fluxo_id FROM fluxos_aprovacao WHERE nome = 'Fluxo Simples' AND ativo = TRUE;
    ELSEIF valor_total <= 5000 THEN
        SELECT id INTO fluxo_id FROM fluxos_aprovacao WHERE nome = 'Fluxo Completo' AND ativo = TRUE;
    ELSE
        SELECT id INTO fluxo_id FROM fluxos_aprovacao WHERE nome = 'Fluxo Cr√≠tico' AND ativo = TRUE;
    END IF;
END//

DELIMITER ;

-- =============================================
-- TRIGGERS
-- =============================================

DELIMITER //

-- TRIGGER PARA CRIAR C√ìDIGO DE SOLICITA√á√ÉO
CREATE TRIGGER before_solicitacao_insert
BEFORE INSERT ON solicitacoes
FOR EACH ROW
BEGIN
    IF NEW.codigo_solicitacao IS NULL THEN
        CALL GerarCodigoSolicitacao(NEW.codigo_solicitacao);
    END IF;
END//

-- TRIGGER PARA ATUALIZAR ESTOQUE AP√ìS MOVIMENTA√á√ÉO
CREATE TRIGGER after_movimentacao_insert
AFTER INSERT ON movimentacoes
FOR EACH ROW
BEGIN
    IF NEW.tipo = 'entrada' THEN
        UPDATE itens SET quantidade = quantidade + NEW.quantidade WHERE id = NEW.item_id;
    ELSEIF NEW.tipo IN ('saida', 'devolucao') THEN
        UPDATE itens SET quantidade = quantidade - NEW.quantidade WHERE id = NEW.item_id;
    END IF;
    
    CALL VerificarAlertasEstoque();
END//

DELIMITER ;

-- =============================================
-- CONSULTA PARA VERIFICAR PERMISS√ïES
-- =============================================

SELECT 
    u.id,
    u.nome,
    u.email,
    u.perfil,
    u.usuario_superior_id,
    s.nome as supervisor_nome,
    u.pode_consultar,
    u.pode_solicitar,
    u.pode_cadastrar,
    u.pode_editar,
    u.permissao_aprovar_solicitacoes,
    u.responsavel_estoque
FROM usuarios u
LEFT JOIN usuarios s ON u.usuario_superior_id = s.id
WHERE u.ativo = true
ORDER BY u.perfil, u.nome;

-- =============================================
-- RESUMO DAS PERMISS√ïES POR PERFIL
-- =============================================

/*
PERFIL              | CONSULTAR | SOLICITAR | CADASTRAR | EDITAR | APROVAR | GERENCIAR ESTOQUE
-------------------|-----------|-----------|-----------|--------|---------|------------------
admin              |    SIM    |    SIM    |    SIM    |  SIM   |   SIM   |       SIM
tecnico_manutencao |    SIM    |    SIM    |    SIM    |  SIM   |   N√ÉO   |       N√ÉO
coordenador        |    SIM    |    SIM    |    SIM    |  SIM   |   SIM   |       N√ÉO
gerente            |    SIM    |    SIM    |    N√ÉO    |  N√ÉO   |   SIM   |       N√ÉO
tecnico            |    SIM    |    SIM    |    SIM    |  SIM   |   N√ÉO   |       N√ÉO
analista           |    SIM    |    SIM    |    N√ÉO    |  N√ÉO   |   N√ÉO   |       N√ÉO
estagiario         |    SIM    |    N√ÉO    |    N√ÉO    |  N√ÉO   |   N√ÉO   |       N√ÉO
aprendiz           |    SIM    |    N√ÉO    |    N√ÉO    |  N√ÉO   |   N√ÉO   |       N√ÉO
*/

-- =============================================
-- FIM DO SCRIPT - PERMISS√ïES CORRETAS
-- =============================================



-- =============================================
-- ATUALIZA√á√ÉO: FLUXOS DE APROVA√á√ÉO - ADMIN APROVA TUDO
-- =============================================

-- =============================================
-- ATUALIZA√á√ÉO: FLUXOS DE APROVA√á√ÉO - ADMIN APROVA TUDO
-- =============================================

-- üóëÔ∏è REMOVER FLUXOS EXISTENTES (CORRIGIDO PARA SAFE MODE)
DELETE FROM fluxos_aprovacao WHERE id > 0;

-- üéØ NOVOS FLUXOS - ADMIN SEMPRE APROVA
INSERT INTO fluxos_aprovacao (nome, descricao, condicoes, niveis, ativo) VALUES
('Fluxo √önico Admin', 'Todas as solicita√ß√µes s√£o aprovadas pelo Admin', '{"todas": true}',
 '[{"nivel": 1, "perfil": "admin", "descricao": "Aprova√ß√£o do Administrador"}]', TRUE),

('Fluxo Backup Coordenador', 'Backup caso Admin n√£o dispon√≠vel', '{"backup": true}',
 '[{"nivel": 1, "perfil": "coordenador", "descricao": "Aprova√ß√£o do Coordenador"},
   {"nivel": 2, "perfil": "admin", "descricao": "Aprova√ß√£o Final do Admin"}]', FALSE);

-- üîß ATUALIZAR PERMISS√ïES DOS USU√ÅRIOS (CORRIGIDO PARA SAFE MODE)
UPDATE usuarios SET 
    permissao_aprovar_solicitacoes = TRUE,
    responsavel_estoque = TRUE
WHERE perfil = 'admin' AND id > 0;

UPDATE usuarios SET 
    permissao_aprovar_solicitacoes = FALSE
WHERE perfil != 'admin' AND id > 0;

-- üìù ATUALIZAR SOLICITA√á√ïES EXISTENTES (CORRIGIDO PARA SAFE MODE)
UPDATE solicitacoes SET 
    status = 'pendente',
    usuario_aprovador_id = NULL
WHERE status IN ('pendente', 'em_analise') AND id > 0;

-- üîî ATUALIZAR/INSERIR CONFIGURA√á√ïES
DELETE FROM configuracoes WHERE chave IN ('APROVADOR_PRINCIPAL', 'APROVACAO_ADMIN_TODAS', 'EMAIL_APROVACAO_ADMIN');

INSERT INTO configuracoes (chave, valor, descricao) VALUES
('APROVADOR_PRINCIPAL', 'admin', 'Perfil que aprova todas as solicita√ß√µes'),
('APROVACAO_ADMIN_TODAS', 'true', 'Admin aprova todas as solicita√ß√µes'),
('EMAIL_APROVACAO_ADMIN', 'admin@empresa.com', 'Email para notificar aprova√ß√µes');



DELIMITER //

-- PROCEDURE PARA DETERMINAR FLUXO DE APROVA√á√ÉO (CORRIGIDA)
DROP PROCEDURE IF EXISTS DeterminarFluxoAprovacao //

CREATE PROCEDURE DeterminarFluxoAprovacao(IN valor_total DECIMAL(10,2), OUT fluxo_id INT)
BEGIN
    -- üéØ SEMPRE USA FLUXO DO ADMIN (independente do valor)
    SELECT id INTO fluxo_id 
    FROM fluxos_aprovacao 
    WHERE nome = 'Fluxo √önico Admin' 
    AND ativo = TRUE 
    LIMIT 1;
END //

DELIMITER ;




ALTER TABLE usuarios 
MODIFY perfil ENUM('admin', 'tecnico_manutencao', 'coordenador', 'gerente', 'tecnico', 'analista', 'estagiario', 'aprendiz', 'admin_estoque');
UPDATE usuarios 
SET perfil = 'admin_estoque' 
WHERE email = 'estoque@empresa.com';